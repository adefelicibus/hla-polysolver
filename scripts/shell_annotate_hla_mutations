DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

#### check if an appropriate number of arguments were passed ####

if [ $# -ne 3 ]; then
        echo 1>&2 Usage: $0 indiv tarZipDir outDir
        echo "  -indiv: individual ID, used as prefix for output files"
        echo "  -tarZipDir: tar zipped directory containing the raw call files (Mutect: call_stats*, Strelka: *all.somatic.indels.vcf)"
	echo "  -outDir: the output directory"
     exit 127
fi

echo "Environment variables"
echo "  -DATA_DIR: directory containing data = $DATA_DIR"

indiv=$1
tarZipDir=$2
outDir=$3

tar xvfz $tarZipDir 

dirPrefix=`$DIR/../scripts/get_prefix.pl $tarZipDir`

echo "dirPrefix=$dirPrefix"

$DIR/../scripts/annotate_hla_mutect.pl $indiv $dirPrefix $DATA_DIR/a_complete.3100.new.eb.fasta $DATA_DIR/b_complete.3100.new.eb.fasta $DATA_DIR/c_complete.3100.new.eb.fasta $DIR/.. $outDir

$DIR/../scripts/filter_hla_mutect.pl $outDir/$indiv.mutect.unfiltered.annotated $indiv $outDir 0 $DIR/..
 
$DIR/../scripts/remove_synonymous_hla_mutect.pl $outDir/$indiv.mutect.filtered.annotated $indiv $outDir

$DIR/../scripts/annotate_hla_strelka_indels.pl $indiv $dirPrefix $DATA_DIR/a_complete.3100.new.eb.fasta $DATA_DIR/b_complete.3100.new.eb.fasta $DATA_DIR/c_complete.3100.new.eb.fasta $DIR/.. $outDir

$DIR/../scripts/filter_hla_strelka_indels.pl $outDir/$indiv.strelka_indels.unfiltered.annotated $indiv $outDir $DIR/..

rm -f $mydir/*mutect.filtered.annotated

